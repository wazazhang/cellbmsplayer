<?xml version="1.0" encoding="utf-8"?>
<mx:Canvas xmlns:mx="http://www.adobe.com/2006/mxml" fontSize="12" width="960" height="600"
		   borderStyle="solid" borderColor="#000000" backgroundColor="#FDFDFD" creationComplete="initEvent()"
		   
		   >

	<mx:Script>
		<![CDATA[
			import Class.Model.Desk;
			import Class.Model.Room;
			import Class.Server;
			
			import com.fc.lami.Messages.DeskData;
			import com.fc.lami.Messages.PlayerData;
			import com.fc.lami.Messages.RoomData;
			
			import mx.controls.Alert;
			
			public var deskCpts:Array;
			
			[Bindable]
			public var room:Room;
			
			[Bindable]
			private var _plist:Array;
			
			private var roomData:RoomData
			
			[Bindable]
			private var roomMessage:String = '';
			
			public function init(roomData:RoomData):void
			{
				deskCpts = new Array();
				plist = room.getPlayerList();
				dgroomlist.dataProvider = roomData.desks
				this.roomData = roomData
			}
			
			public function initEvent():void
			{
				addEventListener(KeyboardEvent.KEY_DOWN,keyDownHandle)
			}
			
			public function keyDownHandle(event:KeyboardEvent):void
			{
				if( event.keyCode==13&&titalk.text!='')
				{
					pubTalk(); 
				}
			}
			
			public function pubTalk():void
			{
				Server.sendTalkMessage(titalk.text);
				titalk.text='';
			}
			
			private function set plist(list:Dictionary):void
			{
				_plist = new Array()
				for each (var player:PlayerData in list)
				{
					_plist.push(player);
				}
			}
			
			public function addRoomInfo(str:String):void
			{
				roomMessage =str + "\n" + roomMessage;
			}
			
			public function getDeskById(deskid:int):DeskData
			{
				for each(var desk:DeskData in roomData.desks)
				{
					if(deskid == desk.desk_id)
					{
						return desk;
					}
				}
				return null
			}
			
			//进入桌子
			public function enterDesk(player_id:int, desk_id:int, seat:int):void
			{
				var curDesk:DeskData = getDeskById(desk_id);
				curDesk.player_number++;
				
				addRoomInfo(room.getPlayerFromPlayerList(player_id).name+'进入'+curDesk.desk_name);
			}
			
			//退出桌子
			public function leaveDesk(player_id:int, desk_id:int):void
			{
				var curDesk:DeskData = getDeskById(desk_id);
				curDesk.player_number--;
				
				addRoomInfo(room.getPlayerFromPlayerList(player_id).name+'离开'+curDesk.desk_name);
			}
			
			
			
			
			//进入房间
			public function enterRoom(player:PlayerData):void
			{
				//nt.player
				if(room!=null)
				{
					room.enterRoom(player);
					plist = room.getPlayerList();
					
				}
				addRoomInfo(player.name+"进入房间")
			}
			
			
			//退出房间 
			public function leaveRoom(player_id:int):void
			{
				var desk_id:int = Server.getPlayerDeskId(player_id);
				addRoomInfo(Server.getPlayer(player_id).name+"离开房间");	
				room.removePlayer(player_id);
				plist = room.getPlayerList();
			}
			
			
			public function onGameStart(deskid:int):void
			{
				var curDesk:DeskData = getDeskById(deskid);
				curDesk.is_started=true;
			}
			
			public function onGameOver(deskid:int):void
			{
				var curDesk:DeskData = getDeskById(deskid);
				curDesk.is_started=false;
			}
			
			public function exitRoom():void
			{
				Server.ExitRoom();
			}
			
			public function is_startedLF(item:Object,column:DataGridColumn):String
			{
				if(item.is_started)
					return "开始";
				else
					return "等待";
			}
			
			
			public function player_numberLF(item:Object,column:DataGridColumn):String
			{				
				return item.player_number+'/4';
			}
			
			public function requestEnterDesk():void
			{
				var desk:DeskData = dgroomlist.selectedItem as DeskData
				if(desk.player_number==4)
				{
					Alert.show("当前桌子已满！");
					return;
				}
					
				Server.enterDesk(desk.desk_id,-1)
			}
			
			public function fastRequestEnterDesk():void
			{
				Server.enterDesk(-1,-1)
			}
			
			
			public function showWaitRoom():void
			{
				if(cb1.selected)
				{
					var arr:Array = new Array();
					for each (var desk:DeskData in roomData.desks)
					{
						if(!desk.is_started)
							arr.push(desk)
					}
					dgroomlist.dataProvider = arr;

				}
				else
				{
					dgroomlist.dataProvider = roomData.desks;
				}
			}
		]]>
	</mx:Script>
	<mx:Canvas x="10" y="10" width="680" height="29" borderStyle="solid" borderColor="#000000">
		<mx:Label text="信息滚动区" horizontalCenter="0" verticalCenter="0"/>
	</mx:Canvas>
	
	<mx:DataGrid id="dgroomlist" x="10" y="52" width="680" height="379" doubleClickEnabled="true"   doubleClick="requestEnterDesk()">
		<mx:columns>
			<mx:DataGridColumn headerText="房间序号" dataField="desk_id" />
			<mx:DataGridColumn width="200" headerText="房间名称" dataField="desk_name"/>
			<mx:DataGridColumn headerText="状态"  dataField="is_started" labelFunction="is_startedLF" />
			<mx:DataGridColumn headerText="人数" dataField="player_number" labelFunction ="player_numberLF" />
			<mx:DataGridColumn headerText="加密" dataField="" />
			
			
		</mx:columns>
	</mx:DataGrid>
	
	<mx:TextArea x="10" y="439" width="680" height="114" text="{roomMessage}" editable="false"/>
	<mx:TextInput id="titalk" x="10" y="566" width="624"/>
	
	<mx:Button x="642" y="566" label="提交" click="pubTalk()"/>
	
	<mx:Canvas x="697" y="52" width="253" height="149" borderStyle="solid" borderColor="#030303">
		<mx:Image x="153" y="49" source="image/head.png"/>
		<mx:Label x="10" y="10" text="等级：888"/>
		<mx:Label x="10" y="38" text="经验：10000"/>
		<mx:Label x="10" y="66" text="总局数：355"/>
		<mx:Label x="10" y="94" text="胜率：66%"/>
		<mx:Label x="10" y="122" text="金币：888"/>
	</mx:Canvas>
	
	<mx:DataGrid x="698" y="209" width="252" height="326" dataProvider="{_plist}">
		<mx:columns>
			<mx:DataGridColumn headerText="ID" dataField="player_id" width="40"/>
			<mx:DataGridColumn headerText="名字" dataField="name" width="80"/>
			<mx:DataGridColumn headerText="等级" dataField="level"/>
		</mx:columns>
	</mx:DataGrid>
	
	<mx:Button x="698" y="543" label="快速加入" width="252" height="47" fontSize="20" fontWeight="bold" click="fastRequestEnterDesk()"/>
	<mx:LinkButton x="876" y="10" label="退出房间" fontSize="12" click="exitRoom()" />
	<mx:CheckBox id="cb1" x="698" y="10" label="只显示等待房间" change="showWaitRoom()"/>
</mx:Canvas>
